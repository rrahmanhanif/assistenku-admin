<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistenku Admin - Login</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/icons/icon-192.png" />
  <link rel="stylesheet" href="/apps/admin/assets/app.css" />
  <script src="/firebase-config.js"></script>
  <script src="/apps/admin/assets/runtime-config.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">Assistenku Admin</div>
    <div class="user-info">Masuk dengan email terdaftar</div>
  </header>

  <main class="content" style="max-width: 520px; margin: 2rem auto;">
    <div class="card">
      <h2>Login Admin</h2>
      <p style="color: var(--muted);">
        Gunakan email yang sudah terdaftar. Masukkan kode admin untuk verifikasi server.
      </p>

      <div class="alert error" data-error style="display:none;"></div>
      <div class="alert success" data-success style="display:none;"></div>

      <form id="login-form">
        <div class="form-field">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="admin@example.com" required />
        </div>

        <div class="form-field">
          <label for="password">Password (opsional, isi jika tersedia)</label>
          <input type="password" id="password" placeholder="••••••••" />
        </div>

        <div class="form-field">
          <label for="admin-code">Kode Admin</label>
          <input type="text" id="admin-code" placeholder="309309" value="309309" required />
        </div>

        <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
          <button class="button" type="submit">Login</button>
          <button class="button secondary" id="send-link" type="button">
            Kirim link login
          </button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>Butuh bantuan?</h3>
      <p style="color: var(--muted);">
        Gunakan email <strong>kontakassistenku@gmail.com</strong> atau hubungi tim
        untuk akses admin.
      </p>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      isSignInWithEmailLink,
      signInWithEmailLink
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      attachLoginHandlers,
      verifyAndCreateSession
    } from "/apps/admin/assets/auth.js";
    import "/apps/admin/assets/app.js";

    const app = initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    window.firebaseAuth = auth;

    const codeInput = document.querySelector("#admin-code");
    if (window.RUNTIME_CONFIG?.adminCodeDefault && codeInput && !codeInput.value) {
      codeInput.value = window.RUNTIME_CONFIG.adminCodeDefault;
    }

    attachLoginHandlers(auth);

    if (isSignInWithEmailLink(auth, window.location.href)) {
      const storedEmail = localStorage.getItem("adminEmailForLink") || "";
      const email =
        storedEmail ||
        window.prompt("Masukkan email yang dipakai untuk meminta link login") ||
        "";

      const errorBox = document.querySelector("[data-error]");
      const showError = (msg) => {
        if (errorBox) {
          errorBox.textContent = msg;
          errorBox.style.display = "block";
        }
      };

      signInWithEmailLink(auth, email, window.location.href)
        .then(async (cred) => {
          const idToken = await cred.user.getIdToken();
          localStorage.setItem("adminUserEmail", cred.user.email || email);
          const code =
            codeInput?.value?.trim() || window.RUNTIME_CONFIG?.adminCodeDefault;
          await verifyAndCreateSession(idToken, code || "");
          window.location.href = "/admin/dashboard.html";
        })
        .catch((err) => {
          showError(err.message || "Login link tidak valid");
        });
    }
  </script>
</body>
</html>
